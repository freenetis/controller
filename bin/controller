#!/bin/sh

# Function to display usage information
usage() {
	echo "Usage: $0 -i <inventory file> [-s <seconds to sleep>] [-v <verbosity level>] [-d <directory>]"
	echo "  -i: Specify the inventory file (required)"
	echo "  -s: Specify the number of seconds to sleep between runs (optional)"
	echo "  -v: Set verbosity level (0-7, default is 0)"
	echo "  -d: Specify the directory containing the playbook (optional, default is current directory)"
	exit 1
}

VERBOSITY=0
DIRECTORY="."

while getopts 'hi:s:d:' opt; do
	case $opt in
	i)
		INVENTORY=$OPTARG
		;;
	s)
		SLEEP=$OPTARG
		;;
	v)
		VERBOSITY=$OPTARG
		;;
	d)
    	DIRECTORY=${OPTARG%/}
    	;;
	*)
		usage
		;;
	esac
done

for i in `seq 1 $VERBOSITY`;
do
	VERBOSE=$VERBOSE"v"
done

if [ -z "$INVENTORY" ]; then
	echo "Inventory is required"
	usage
fi

if [ ! -f "$INVENTORY" ]; then
	echo "Inventory $INVENTORY does not exist"
	exit 1
fi

while true; do
	ansible-playbook ${VERBOSE:+-$VERBOSE} -i "$INVENTORY" "$DIRECTORY/controller.yml"
	state=$?

	if [ -z $SLEEP ]; then
		exit $state
	fi

	echo -e "Sleeping for $SLEEP seconds...\n"
	sleep $SLEEP
done
