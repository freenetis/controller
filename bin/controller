#!/bin/sh

# Function to display usage information
usage() {
 echo "Usage: $0 -i <inventory file> [-s <seconds to sleep>] [-d <debug level>]"
 echo "  -i: Specify the inventory file (required)"
 echo "  -s: Specify the number of seconds to sleep between runs (optional)"
 echo "  -d: Set debug level (0-7, default is 0)"
 exit 1
}

DEBUG=0

while getopts 'hi:s:d:' opt; do
	case $opt in
	i)
		INVENTORY=$OPTARG
		;;
	s)
		SLEEP=$OPTARG
		;;
	d)
		DEBUG=$OPTARG
		;;
	*)
		usage
		;;
	esac
done

for i in `seq 1 $DEBUG`;
do
	VERBOSE=$VERBOSE"v"
done

if [ -z "$INVENTORY" ]; then
	echo "Inventory is required"
	usage
fi

if [ ! -f "$INVENTORY" ]; then
	echo "Inventory $INVENTORY does not exist"
	exit 1
fi

while true; do
	ansible-playbook ${VERBOSE:+-$VERBOSE} -i "$INVENTORY" controller.yml
	state=$?

	if [ -z $SLEEP ]; then
		exit $state
	fi

	echo -e "Sleeping for $SLEEP seconds...\n"
	sleep $SLEEP
done
